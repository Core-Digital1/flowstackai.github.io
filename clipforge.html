<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClipForge AI - Pro Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Fabric.js for Canvas Editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- Background Removal AI -->
    <script
        src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.3.0/dist/imgly-background-removal.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .tool-btn {
            @apply p-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-xl transition flex flex-col items-center gap-1 text-xs;
        }

        .tool-btn.active {
            @apply text-purple-400 bg-purple-500/10;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #a855f7;
            cursor: pointer;
            margin-top: -6px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 2px;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen overflow-hidden">

    <!-- APP CONTAINER -->
    <div id="app" class="h-full flex flex-col">
        <!-- Views will be toggled here -->
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeAuthModal()"></div>
        <div class="relative bg-gray-900 border border-gray-700 rounded-2xl p-8 w-full max-w-md cursor-auto">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 id="modal-title" class="text-2xl font-bold text-white mb-6">Welcome</h2>
            <div id="auth-message" class="mb-4 p-3 rounded-lg hidden"></div>

            <form id="auth-form" class="space-y-4" onsubmit="handleAuthSubmit(event)">
                <div id="name-field" class="relative hidden">
                    <i data-lucide="user" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="text" id="input-name" placeholder="Full Name"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                </div>

                <div class="relative">
                    <i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="email" id="input-email" inputs="email" placeholder="Email" required
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                </div>

                <div class="relative">
                    <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="password" id="input-password" placeholder="Password" required minlength="6"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-12 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                </div>

                <button type="submit" id="auth-submit-btn"
                    class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    LOG IN
                </button>
            </form>

            <div class="text-center text-gray-400 mt-6 space-y-2" id="auth-footer">
                <!-- Links injected by JS -->
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- CONFIGURATION ---
        const supabaseUrl = 'https://mgoaydvrlelrwompqjph.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nb2F5ZHZybGVscndvbXBxanBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjM2MzcsImV4cCI6MjA4NTA5OTYzN30.WGIJPXxL0QhBo3TpcTf8bNX9YMbVEtZztX1NtToZXRM';

        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: { storage: window.sessionStorage }
        });

        // --- STATE ---
        let currentUser = null;
        let currentAuthMode = 'login';
        let activeTab = 'editor';
        let canvas = null;
        let activeObject = null;
        let editorState = {
            backgroundColor: '#000000',
            aspectRatio: '9:16',
            zoom: 1
        };

        // --- VIEWS HTML TEMPLATES ---
        const LANDING_VIEW = `
            <div class="overflow-y-auto h-screen">
                <nav class="fixed w-full z-40 bg-gray-900/80 backdrop-blur-md border-b border-gray-800">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-6 h-6 text-purple-500"></i>
                                <span class="text-xl font-bold bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">ClipForge AI</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <button onclick="openAuthModal('login')" class="text-gray-300 hover:text-white px-3 py-2 text-sm font-medium transition">Log in</button>
                                <button onclick="openAuthModal('signup')" class="bg-white text-gray-900 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-100 transition">Sign up</button>
                            </div>
                        </div>
                    </div>
                </nav>

                <section class="pt-32 pb-20 px-4 text-center">
                    <div class="max-w-7xl mx-auto">
                        <div class="inline-flex items-center gap-2 bg-purple-500/20 border border-purple-500/30 rounded-full px-4 py-2 mb-8">
                            <i data-lucide="zap" class="w-4 h-4 text-purple-400"></i>
                            <span class="text-purple-300 text-sm">AI-Powered Video Editing</span>
                        </div>
                        <h1 class="text-5xl md:text-7xl font-bold mb-6 bg-gradient-to-r from-white via-purple-200 to-blue-200 bg-clip-text text-transparent">
                            Turn Long Videos Into<br />
                            <span class="bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text">Viral Shorts</span>
                        </h1>
                        <p class="text-xl text-gray-400 max-w-2xl mx-auto mb-10">
                            Professional Editor with Manual Tools & Real AI Background Removal directly in your browser.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onclick="openAuthModal('signup')" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-4 rounded-full font-semibold text-lg hover:opacity-90 transition shadow-lg shadow-purple-500/25">
                                Start Creating Free
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        `;

        const DASHBOARD_VIEW = (userEmail) => `
            <div class="flex h-screen overflow-hidden">
                <!-- SIDEBAR NAV -->
                <aside class="w-20 bg-gray-900 border-r border-gray-800 flex flex-col items-center py-6 z-20">
                    <div class="mb-8">
                        <i data-lucide="zap" class="w-8 h-8 text-purple-500"></i>
                    </div>
                    <nav class="flex-1 w-full space-y-6 flex flex-col items-center">
                        <button onclick="switchTab('editor')" id="nav-editor" class="p-3 rounded-xl text-purple-400 bg-purple-500/10 transition group relative">
                            <i data-lucide="scissors" class="w-6 h-6"></i>
                            <span class="absolute left-14 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-50 pointer-events-none">Editor</span>
                        </button>
                         <button onclick="switchTab('upload')" id="nav-upload" class="p-3 rounded-xl text-gray-400 hover:text-white hover:bg-gray-800 transition group relative">
                            <i data-lucide="upload" class="w-6 h-6"></i>
                            <span class="absolute left-14 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-50 pointer-events-none">Uploads</span>
                        </button>
                        <button onclick="switchTab('settings')" id="nav-settings" class="p-3 rounded-xl text-gray-400 hover:text-white hover:bg-gray-800 transition group relative">
                            <i data-lucide="settings" class="w-6 h-6"></i>
                            <span class="absolute left-14 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-50 pointer-events-none">Settings</span>
                        </button>
                    </nav>
                    <div class="mt-auto">
                        <button onclick="logout()" class="p-3 rounded-xl text-gray-400 hover:text-red-400 hover:bg-red-500/10 transition">
                            <i data-lucide="log-out" class="w-6 h-6"></i>
                        </button>
                    </div>
                </aside>

                <!-- MAIN WORKSPACE -->
                <div class="flex-1 flex flex-col h-full bg-gray-950 relative" id="workspace-area">
                    <!-- Tabs Content Injected Here -->
                </div>
            </div>
        `;

        // --- EDITOR TEMPLATE ---
        function getEditorTemplate() {
            return `
                <!-- HEADER -->
                <header class="h-14 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-6">
                    <div class="flex items-center gap-4">
                        <h2 class="font-semibold text-white">Untitled Project</h2>
                        <span class="text-xs px-2 py-1 bg-gray-800 rounded text-gray-400">9:16 Shorts</span>
                    </div>
                    <div class="flex items-center gap-3">
                         <button class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg text-sm font-medium hover:opacity-90 transition">Download</button>
                    </div>
                </header>

                <div class="flex-1 flex overflow-hidden">
                    <!-- TOOLS (LEFT) -->
                    <div class="w-72 bg-gray-900 border-r border-gray-800 flex flex-col z-10">
                        <div class="p-4 border-b border-gray-800 overflow-x-auto">
                            <div class="flex gap-2">
                                <button onclick="setToolCategory('elements')" class="px-3 py-1.5 bg-gray-800 rounded-lg text-sm text-white whitespace-nowrap hover:bg-gray-700">Elements</button>
                                <button onclick="setToolCategory('text')" class="px-3 py-1.5 bg-transparent hover:bg-gray-800 rounded-lg text-sm text-gray-400 whitespace-nowrap">Text</button>
                                <button onclick="setToolCategory('ai')" class="px-3 py-1.5 bg-purple-500/10 text-purple-400 border border-purple-500/20 rounded-lg text-sm whitespace-nowrap hover:bg-purple-500/20">✨ AI Tools</button>
                            </div>
                        </div>
                        <div id="tools-content" class="flex-1 overflow-y-auto p-4 space-y-6"></div>
                    </div>

                    <!-- CANVAS (CENTER) -->
                    <div class="flex-1 bg-gray-950 flex flex-col relative w-full overflow-hidden">
                        <div class="flex-1 flex items-center justify-center p-8 overflow-hidden bg-gray-950/50" id="canvas-wrapper">
                            <canvas id="main-canvas"></canvas>
                        </div>
                        
                        <!-- TIMELINE (BOTTOM) -->
                         <div class="h-48 bg-gray-900 border-t border-gray-800 p-4">
                            <div class="flex justify-between text-xs text-gray-400 mb-2">
                                <span>Timeline</span>
                                <span id="time-display">00:00 / 01:00</span>
                            </div>
                            <div class="relative h-24 bg-gray-950 rounded-lg border border-gray-800 overflow-hidden" id="timeline-track">
                                <div class="absolute inset-y-0 left-0 w-full flex p-2 gap-1 overflow-x-auto" id="timeline-clips">
                                    <div class="h-full w-32 bg-gray-800 rounded border border-gray-700 flex items-center justify-center text-xs text-gray-500">
                                        Drag clips here
                                    </div>
                                </div>
                                <div class="absolute top-0 bottom-0 left-4 w-0.5 bg-red-500 z-10 pointer-events-none"></div>
                            </div>
                            <div class="flex justify-center gap-4 mt-3">
                                <button class="p-1.5 rounded-full hover:bg-gray-800"><i data-lucide="play" class="w-4 h-4 fill-current"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- PROPERTIES (RIGHT) -->
                    <div class="w-64 bg-gray-900 border-l border-gray-800 p-4 overflow-y-auto" id="properties-panel">
                        <div class="text-center text-gray-500 mt-10">
                            <i data-lucide="mouse-pointer-2" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p class="text-sm">Select an object</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- INIT LISTENER ---
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                renderDashboard();
            } else {
                renderLanding();
            }
            lucide.createIcons();
        });

        // --- RENDER SYSTEM ---
        function renderLanding() {
            document.getElementById('app').innerHTML = LANDING_VIEW;
            lucide.createIcons();
        }

        function renderDashboard() {
            if (!currentUser) return;
            document.getElementById('app').innerHTML = DASHBOARD_VIEW(currentUser.email);
            switchTab('editor');
        }

        function switchTab(tab) {
            activeTab = tab;
            // Update Nav State
            ['editor', 'upload', 'settings'].forEach(t => {
                const btn = document.getElementById(`nav-${t}`);
                if (btn) {
                    if (t === tab) {
                        btn.className = "p-3 rounded-xl text-purple-400 bg-purple-500/10 transition group relative";
                    } else {
                        btn.className = "p-3 rounded-xl text-gray-400 hover:text-white hover:bg-gray-800 transition group relative";
                    }
                }
            });

            const workspace = document.getElementById('workspace-area');

            if (tab === 'editor') {
                workspace.innerHTML = getEditorTemplate();
                initCanvas();
                setToolCategory('elements');
            } else if (tab === 'upload') {
                renderUploadTab(workspace);
            } else if (tab === 'settings') {
                renderSettingsTab(workspace);
            }
            lucide.createIcons();
        }

        function renderUploadTab(container) {
            container.innerHTML = `
                <div class="p-12 max-w-4xl mx-auto w-full">
                    <h1 class="text-3xl font-bold mb-8">Upload Assets</h1>
                    <div class="border-2 border-dashed border-gray-700 bg-gray-900/50 rounded-2xl p-12 text-center hover:border-purple-500 transition cursor-pointer" onclick="document.getElementById('global-upload').click()">
                        <i data-lucide="cloud-upload" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                        <p class="text-xl text-gray-300 mb-2">Drag & Drop files here</p>
                        <p class="text-gray-500 text-sm">Supports JPG, PNG, MP4</p>
                        <button class="mt-6 px-6 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm font-medium transition">Browse Files</button>
                        <input type="file" id="global-upload" class="hidden" accept="image/*,video/*">
                    </div>
                </div>
            `;
        }

        function renderSettingsTab(container) {
            container.innerHTML = `
                <div class="p-12 max-w-2xl mx-auto w-full">
                    <h1 class="text-3xl font-bold mb-8">Settings</h1>
                    <div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 space-y-6">
                        <div>
                            <h3 class="font-semibold mb-4 text-purple-400">API Configurations (Real AI)</h3>
                            <p class="text-sm text-gray-400 mb-4">For heavy tasks like "Long to Shorts" or Text Generation, we use powerful cloud AI. Enter your keys below to enable these features.</p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1">OpenAI API Key (ChatGPT/DALL-E)</label>
                                    <input type="password" placeholder="sk-..." class="w-full bg-gray-950 border border-gray-800 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1">Replicate API Key (Image/Video Gen)</label>
                                    <input type="password" placeholder="r8_..." class="w-full bg-gray-950 border border-gray-800 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none">
                                </div>
                            </div>
                        </div>
                        <div>
                            <button class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium transition" onclick="alert('Keys saved to browser storage!')">Save Keys</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- EDITOR CORE ---
        function initCanvas() {
            setTimeout(() => {
                const wrapper = document.getElementById('canvas-wrapper');
                if (!wrapper) return;
                const height = wrapper.clientHeight - 80;
                const width = height * (9 / 16);
                const cEl = document.getElementById('main-canvas');
                cEl.width = width;
                cEl.height = height;

                canvas = new fabric.Canvas('main-canvas', {
                    width: width, height: height, backgroundColor: '#000'
                });

                canvas.on('selection:created', handleSelection);
                canvas.on('selection:updated', handleSelection);
                canvas.on('selection:cleared', () => { activeObject = null; renderPropertiesPanel(); });
            }, 100);
        }

        function setToolCategory(cat) {
            const container = document.getElementById('tools-content');
            if (cat === 'elements') {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Basic Shapes</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="addRect()" class="aspect-square bg-gray-800 rounded-lg hover:bg-gray-700 flex items-center justify-center"><div class="w-8 h-8 border-2 border-gray-400"></div></button>
                                <button onclick="addCircle()" class="aspect-square bg-gray-800 rounded-lg hover:bg-gray-700 flex items-center justify-center"><div class="w-8 h-8 border-2 border-gray-400 rounded-full"></div></button>
                                <button onclick="addTriangle()" class="aspect-square bg-gray-800 rounded-lg hover:bg-gray-700 flex items-center justify-center"><div class="w-0 h-0 border-l-[10px] border-l-transparent border-t-[15px] border-t-transparent border-r-[10px] border-r-transparent border-b-[15px] border-b-gray-400"></div></button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Images</h3>
                            <button onclick="document.getElementById('img-upload').click()" class="w-full py-8 border-2 border-dashed border-gray-700 rounded-xl hover:border-purple-500 text-gray-500 hover:text-purple-400 transition flex flex-col items-center gap-2">
                                <i data-lucide="image-plus" class="w-6 h-6"></i>
                                <span class="text-xs">Upload Device Image</span>
                            </button>
                            <input type="file" id="img-upload" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                        </div>
                    </div>`;
            } else if (cat === 'text') {
                container.innerHTML = `
                    <div class="space-y-4">
                        <button onclick="addText('Heading', {fontSize: 32, fontWeight: 'bold'})" class="w-full p-4 bg-gray-800 rounded-xl hover:bg-gray-700 text-left"><span class="text-xl font-bold text-white">Heading</span></button>
                        <button onclick="addText('Subtitle', {fontSize: 24})" class="w-full p-4 bg-gray-800 rounded-xl hover:bg-gray-700 text-left"><span class="text-lg text-gray-300">Subtitle</span></button>
                        <button onclick="addText('Body text', {fontSize: 16})" class="w-full p-4 bg-gray-800 rounded-xl hover:bg-gray-700 text-left"><span class="text-sm text-gray-400">Body text...</span></button>
                    </div>`;
            } else if (cat === 'ai') {
                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- BG REMOVAL -->
                        <div class="p-4 bg-gray-800/50 border border-gray-700 rounded-xl">
                            <h3 class="flex items-center gap-2 text-sm font-semibold text-white mb-2"><i data-lucide="eraser" class="w-4 h-4 text-purple-400"></i> Magic Eraser</h3>
                             <button onclick="removeBackground()" class="w-full py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium text-white transition">Remove Background</button>
                             <p class="text-xs text-gray-500 mt-2">Runs locally in your browser.</p>
                        </div>
                        
                        <!-- LONG TO SHORT -->
                        <div class="p-4 bg-gradient-to-br from-purple-900/20 to-blue-900/20 border border-purple-500/20 rounded-xl">
                             <h3 class="flex items-center gap-2 text-sm font-semibold text-white mb-2"><i data-lucide="scissors" class="w-4 h-4 text-purple-400"></i> Long to Shorts</h3>
                             <p class="text-xs text-gray-400 mb-3">Detect viral moments from long videos.</p>
                             <div id="lts-area">
                                 <button onclick="document.getElementById('video-upload').click()" class="w-full py-6 border border-dashed border-gray-600 rounded-lg hover:border-purple-500 text-gray-500 text-xs flex flex-col items-center">
                                     <i data-lucide="video" class="w-5 h-5 mb-1"></i> Upload MP4
                                 </button>
                                 <input type="file" id="video-upload" class="hidden" accept="video/*" onchange="runLongToShorts(event)">
                             </div>
                             <p class="text-[10px] text-gray-500 mt-2 text-center">Requires API Key for full analysis.</p>
                        </div>
                    </div>`;
            }
            lucide.createIcons();
        }

        function addRect() { canvas.add(new fabric.Rect({ left: 50, top: 50, fill: '#8b5cf6', width: 60, height: 60 })); }
        function addCircle() { canvas.add(new fabric.Circle({ left: 80, top: 80, fill: '#ec4899', radius: 30 })); }
        function addTriangle() { canvas.add(new fabric.Triangle({ left: 100, top: 50, fill: '#3b82f6', width: 60, height: 60 })); }
        function addText(txt, opts) { canvas.add(new fabric.IText(txt, { left: 50, top: 100, fill: '#fff', fontFamily: 'Inter', ...opts })); canvas.setActiveObject(canvas.getObjects().slice(-1)[0]); }

        function handleImageUpload(e) {
            const reader = new FileReader();
            reader.onload = (f) => fabric.Image.fromURL(f.target.result, img => { img.scaleToWidth(200); canvas.add(img); canvas.setActiveObject(img); });
            reader.readAsDataURL(e.target.files[0]);
        }

        function handleSelection(e) { activeObject = e.selected ? e.selected[0] : null; renderPropertiesPanel(); }

        function renderPropertiesPanel() {
            const panel = document.getElementById('properties-panel');
            if (!activeObject) {
                panel.innerHTML = `<div class="text-center text-gray-500 mt-10"><i data-lucide="mouse-pointer-2" class="w-8 h-8 mx-auto mb-2 opacity-50"></i><p class="text-sm">Select object</p><input type="color" onchange="canvas.setBackgroundColor(this.value, canvas.renderAll.bind(canvas))" class="mt-4 w-6 h-6 rounded border-0"></div>`; lucide.createIcons(); return;
            }
            panel.innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase">Properties</h3>
                    <div><label class="text-xs text-gray-400">Color</label><input type="color" value="${activeObject.fill}" onchange="activeObject.set('fill', this.value); canvas.renderAll();" class="w-full h-8 rounded mt-1"></div>
                    <div><label class="text-xs text-gray-400">Opacity</label><input type="range" min="0" max="1" step="0.1" value="${activeObject.opacity}" oninput="activeObject.set('opacity', parseFloat(this.value)); canvas.renderAll();" class="w-full mt-1"></div>
                    <button onclick="canvas.remove(activeObject); canvas.discardActiveObject(); renderPropertiesPanel();" class="w-full py-2 bg-red-500/10 text-red-400 rounded-lg text-xs">Delete</button>
                </div>`;
            lucide.createIcons();
        }

        // --- AI LOGIC ---
        async function removeBackground() {
            if (!activeObject || activeObject.type !== 'image') { alert('Select an image first!'); return; }
            const btn = document.querySelector('button[onclick="removeBackground()"]');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = 'Processing...'; btn.disabled = true;
            try {
                const blob = await imglyRemoveBackground(activeObject.toDataURL({ format: 'png' }));
                fabric.Image.fromURL(URL.createObjectURL(blob), img => {
                    img.set({ left: activeObject.left, top: activeObject.top, scaleX: activeObject.scaleX, scaleY: activeObject.scaleY });
                    canvas.remove(activeObject); canvas.add(img); canvas.setActiveObject(img);
                    btn.innerHTML = oldHtml; btn.disabled = false;
                });
            } catch (e) { alert('Error: ' + e.message); btn.innerHTML = oldHtml; btn.disabled = false; }
        }

        // --- LONG TO SHORTS SIMULATION ---
        function runLongToShorts(e) {
            const file = e.target.files[0];
            if (!file) return;

            const area = document.getElementById('lts-area');
            area.innerHTML = `
                <div class="space-y-3 p-2 bg-gray-900 rounded-lg border border-purple-500/30">
                    <div class="flex items-center gap-2 text-xs text-purple-300">
                        <i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Analyzing Video...
                    </div>
                    <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-purple-500 w-1/3 loading-shimmer"></div>
                    </div>
                    <p class="text-[10px] text-gray-500">Detecting scenes & virality score...</p>
                </div>
            `;
            lucide.createIcons();

            // Simulate Process
            setTimeout(() => {
                area.innerHTML = `
                    <div class="text-center p-2">
                        <div class="text-xs text-green-400 mb-2 font-medium">✨ Analysis Complete!</div>
                        <p class="text-[10px] text-gray-400 mb-3">3 Viral Clips Detected</p>
                        <div class="space-y-2">
                            <button onclick="addToTimeline('Clip 1')" class="w-full p-2 bg-gray-800 hover:bg-gray-700 rounded text-[10px] text-left flex justify-between"><span>Clip #1 (High Energy)</span> <span class="text-green-500">98/100</span></button>
                            <button onclick="addToTimeline('Clip 2')" class="w-full p-2 bg-gray-800 hover:bg-gray-700 rounded text-[10px] text-left flex justify-between"><span>Clip #2 (Hook)</span> <span class="text-yellow-500">85/100</span></button>
                        </div>
                    </div>
                `;
            }, 3000);
        }

        function addToTimeline(name) {
            const track = document.getElementById('timeline-clips');
            track.innerHTML += `<div class="h-full w-24 bg-purple-900/50 border border-purple-500/50 rounded flex-shrink-0 flex items-center justify-center text-[10px] text-purple-200">${name}</div>`;
        }

        // --- AUTH ---
        function openAuthModal(mode) { currentAuthMode = mode; updateModalUI(); document.getElementById('auth-modal').classList.remove('hidden'); }
        function closeAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }
        function updateModalUI() { /* Identical to previous impl */
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('auth-submit-btn');
            const footer = document.getElementById('auth-footer');
            const nameField = document.getElementById('name-field');
            nameField.classList.add('hidden');
            if (currentAuthMode === 'login') {
                title.textContent = 'Log In'; btn.textContent = 'LOG IN';
                footer.innerHTML = `<p>Don't have an account? <span onclick="openAuthModal('signup')" class="text-purple-400 cursor-pointer hover:text-purple-300">Sign Up</span></p>`;
            } else {
                title.textContent = 'Create Account'; btn.textContent = 'CREATE ACCOUNT';
                nameField.classList.remove('hidden');
                footer.innerHTML = `<p>Already have an account? <span onclick="openAuthModal('login')" class="text-purple-400 cursor-pointer hover:text-purple-300">Log In</span></p>`;
            }
        }
        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            try {
                let { data, error } = currentAuthMode === 'signup' ? await supabase.auth.signUp({ email, password }) : await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                if (data.session) { currentUser = data.user; closeAuthModal(); renderDashboard(); }
                else alert('Check email for confirmation.');
            } catch (err) { alert(err.message); }
        }
        async function logout() { await supabase.auth.signOut(); currentUser = null; renderLanding(); }
    </script>
</body>

</html>